# ==============================================================================
# ESP32 OTA Partition Table (4MB Flash)
# ==============================================================================
#
# This partition layout supports dual-partition OTA updates with rollback.
#
# Memory Layout (4MB = 0x400000 bytes):
# +----------+--------+----------+--------+---------------------------------------+
# | Name     | Offset | Size     | Size   | Description                           |
# +----------+--------+----------+--------+---------------------------------------+
# | Bootldr  | 0x1000 | -        | 28KB   | Second stage bootloader (ESP-IDF)     |
# | PartTbl  | 0x8000 | -        | 4KB    | Partition table (this file)           |
# | NVS      | 0x9000 | 0x5000   | 20KB   | Non-volatile storage (WiFi, config)   |
# | OtaData  | 0xE000 | 0x2000   | 8KB    | OTA state (which partition to boot)   |
# | App0     | 0x10000| 0x140000 | 1.25MB | OTA slot 0 (ota_0) - Firmware         |
# | App1     | 0x150000|0x140000 | 1.25MB | OTA slot 1 (ota_1) - Firmware         |
# | SPIFFS   | 0x290000|0x170000 | 1.4MB  | Filesystem for config, logs, etc.     |
# +----------+--------+----------+--------+---------------------------------------+
# Total used: 4MB (0x400000)
#
# ==============================================================================
# OTA Boot Flow:
# ==============================================================================
#
# 1. Power-on Reset:
#    - ROM bootloader loads second stage bootloader from 0x1000
#    - Second stage bootloader reads otadata partition at 0xE000
#    - otadata contains boot sequence number and validity flags
#
# 2. Partition Selection:
#    - If both partitions valid: boot partition with higher sequence number
#    - If one partition invalid: boot the valid partition
#    - If new partition pending validation: boot it, mark for rollback if fails
#
# 3. After OTA Update:
#    - New firmware is written to the non-running partition
#    - otadata is updated to mark new partition as "pending verification"
#    - On reboot, bootloader boots new partition
#    - If app calls esp_ota_mark_app_valid_cancel_rollback(): partition confirmed
#    - If app crashes or doesn't validate: bootloader rolls back on next boot
#
# ==============================================================================
# Partition Types:
# ==============================================================================
#
# Type "app" subtypes:
#   - ota_0 (0x10): First OTA application partition
#   - ota_1 (0x11): Second OTA application partition
#   - factory (0x00): Factory default (not used in this layout)
#
# Type "data" subtypes:
#   - nvs (0x02): Non-volatile storage
#   - ota (0x00): OTA metadata (boot selection)
#   - spiffs (0x82): SPI Flash File System
#
# ==============================================================================
# Firmware Size Limits:
# ==============================================================================
#
# Maximum firmware size: 1,310,720 bytes (1.25MB / 0x140000)
#
# Typical firmware sizes:
#   - Minimal (no WiFi/BT): ~200KB
#   - With WiFi: ~700KB
#   - With WiFi + BLE: ~1MB
#   - Full featured: ~1.1MB
#
# Reserve ~10% headroom for future growth.
#
# ==============================================================================
# Modifying This Table:
# ==============================================================================
#
# To modify partition sizes:
# 1. Ensure offsets are contiguous (no gaps)
# 2. Ensure total size does not exceed flash size (4MB)
# 3. App partitions must be at least 64KB
# 4. Both OTA partitions must be same size
# 5. Run: pio run -t uploadfs (if changing SPIFFS)
#
# To use larger app partitions (3MB flash for apps):
# - Remove or reduce SPIFFS
# - Increase app0/app1 to 0x180000 (1.5MB each)
#
# ==============================================================================

# Name,   Type, SubType, Offset,   Size,      Flags
nvs,      data, nvs,     0x9000,   0x5000,
otadata,  data, ota,     0xE000,   0x2000,
app0,     app,  ota_0,   0x10000,  0x140000,
app1,     app,  ota_1,   0x150000, 0x140000,
spiffs,   data, spiffs,  0x290000, 0x170000,
